{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.28.1.47646",
      "templateHash": "16097029071121018179"
    }
  },
  "parameters": {
    "deploymentName": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "useExistingResourceGroup": {
      "type": "bool",
      "defaultValue": false
    },
    "existingResourceGroupName": {
      "type": "string",
      "defaultValue": ""
    },
    "useExistingLogAnalytics": {
      "type": "bool",
      "defaultValue": false
    },
    "existingLogAnalyticsWorkspaceId": {
      "type": "string",
      "defaultValue": ""
    },
    "logAnalyticsWorkspaceName": {
      "type": "string"
    },
    "retentionInDays": {
      "type": "int",
      "defaultValue": 90
    },
    "monitorExistingVMs": {
      "type": "bool",
      "defaultValue": true
    },
    "selectedVMIds": {
      "type": "array",
      "defaultValue": []
    },
    "autoEnrollNewVMs": {
      "type": "bool",
      "defaultValue": true
    },
    "enableCPUAlerts": {
      "type": "bool",
      "defaultValue": true
    },
    "cpuThreshold": {
      "type": "int",
      "defaultValue": 85
    },
    "enableMemoryAlerts": {
      "type": "bool",
      "defaultValue": true
    },
    "memoryThreshold": {
      "type": "int",
      "defaultValue": 85
    },
    "enableDiskAlerts": {
      "type": "bool",
      "defaultValue": true
    },
    "diskThreshold": {
      "type": "int",
      "defaultValue": 85
    },
    "enableHeartbeatAlerts": {
      "type": "bool",
      "defaultValue": true
    },
    "createActionGroup": {
      "type": "bool",
      "defaultValue": true
    },
    "actionGroupName": {
      "type": "string"
    },
    "emailRecipients": {
      "type": "string"
    },
    "deployDashboard": {
      "type": "bool",
      "defaultValue": true
    },
    "dashboardName": {
      "type": "string",
      "defaultValue": "VM Monitoring Dashboard"
    },
    "tagsByResource": {
      "type": "object",
      "defaultValue": {}
    }
  },
  "variables": {
    "resourceGroupName": "[if(parameters('useExistingResourceGroup'), parameters('existingResourceGroupName'), format('rg-{0}', parameters('deploymentName')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "condition": "[not(parameters('useExistingResourceGroup'))]",
      "tags": "[if(contains(parameters('tagsByResource'), 'Microsoft.Resources/resourceGroups'), parameters('tagsByResource')['Microsoft.Resources/resourceGroups'], createObject())]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "nestedDeployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "Inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "deploymentName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "useExistingLogAnalytics": {
              "type": "bool"
            },
            "existingLogAnalyticsWorkspaceId": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "retentionInDays": {
              "type": "int"
            },
            "monitorExistingVMs": {
              "type": "bool"
            },
            "selectedVMIds": {
              "type": "array"
            },
            "autoEnrollNewVMs": {
              "type": "bool"
            },
            "enableCPUAlerts": {
              "type": "bool"
            },
            "cpuThreshold": {
              "type": "int"
            },
            "enableMemoryAlerts": {
              "type": "bool"
            },
            "memoryThreshold": {
              "type": "int"
            },
            "enableDiskAlerts": {
              "type": "bool"
            },
            "diskThreshold": {
              "type": "int"
            },
            "enableHeartbeatAlerts": {
              "type": "bool"
            },
            "createActionGroup": {
              "type": "bool"
            },
            "actionGroupName": {
              "type": "string"
            },
            "emailRecipients": {
              "type": "string"
            },
            "deployDashboard": {
              "type": "bool"
            },
            "dashboardName": {
              "type": "string"
            },
            "tagsByResource": {
              "type": "object"
            }
          },
          "resources": [],
          "outputs": {
            "message": {
              "type": "string",
              "value": "Deployment initiated successfully"
            }
          }
        },
        "parameters": {
          "deploymentName": {
            "value": "[parameters('deploymentName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "useExistingLogAnalytics": {
            "value": "[parameters('useExistingLogAnalytics')]"
          },
          "existingLogAnalyticsWorkspaceId": {
            "value": "[parameters('existingLogAnalyticsWorkspaceId')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "retentionInDays": {
            "value": "[parameters('retentionInDays')]"
          },
          "monitorExistingVMs": {
            "value": "[parameters('monitorExistingVMs')]"
          },
          "selectedVMIds": {
            "value": "[parameters('selectedVMIds')]"
          },
          "autoEnrollNewVMs": {
            "value": "[parameters('autoEnrollNewVMs')]"
          },
          "enableCPUAlerts": {
            "value": "[parameters('enableCPUAlerts')]"
          },
          "cpuThreshold": {
            "value": "[parameters('cpuThreshold')]"
          },
          "enableMemoryAlerts": {
            "value": "[parameters('enableMemoryAlerts')]"
          },
          "memoryThreshold": {
            "value": "[parameters('memoryThreshold')]"
          },
          "enableDiskAlerts": {
            "value": "[parameters('enableDiskAlerts')]"
          },
          "diskThreshold": {
            "value": "[parameters('diskThreshold')]"
          },
          "enableHeartbeatAlerts": {
            "value": "[parameters('enableHeartbeatAlerts')]"
          },
          "createActionGroup": {
            "value": "[parameters('createActionGroup')]"
          },
          "actionGroupName": {
            "value": "[parameters('actionGroupName')]"
          },
          "emailRecipients": {
            "value": "[parameters('emailRecipients')]"
          },
          "deployDashboard": {
            "value": "[parameters('deployDashboard')]"
          },
          "dashboardName": {
            "value": "[parameters('dashboardName')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    }
  }
}