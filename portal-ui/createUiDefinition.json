{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": true,
      "basics": {
        "description": "Deploy enterprise-grade VM monitoring with Azure Monitor Hub",
        "resourceGroup": {
          "allowExisting": true
        },
        "location": {
          "visible": true,
          "resourceTypes": [
            "Microsoft.OperationalInsights/workspaces"
          ]
        }
      }
    },
    "basics": [
      {
        "name": "deploymentName",
        "type": "Microsoft.Common.TextBox",
        "label": "Deployment Name",
        "placeholder": "prod-monitoring",
        "defaultValue": "",
        "toolTip": "Unique name for this monitoring deployment",
        "constraints": {
          "required": true,
          "regex": "^[a-z0-9-]{3,24}$",
          "validationMessage": "Only lowercase letters, numbers, and hyphens. Length 3-24."
        }
      }
    ],
    "steps": [
      {
        "name": "infrastructure",
        "label": "Infrastructure",
        "elements": [
          {
            "name": "logAnalyticsSection",
            "type": "Microsoft.Common.Section",
            "label": "Log Analytics Workspace",
            "elements": [
              {
                "name": "newOrExisting",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Log Analytics Workspace",
                "defaultValue": "new",
                "toolTip": "Create a new workspace or use an existing one",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Create new",
                      "value": "new"
                    },
                    {
                      "label": "Use existing",
                      "value": "existing"
                    }
                  ],
                  "required": true
                }
              },
              {
                "name": "name",
                "type": "Microsoft.Common.TextBox",
                "label": "Workspace Name",
                "defaultValue": "[concat('law-', basics('deploymentName'))]",
                "toolTip": "Name for the Log Analytics Workspace",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9-]{4,63}$",
                  "validationMessage": "Alphanumeric and hyphens. Length 4-63."
                },
                "visible": "[equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'new')]"
              },
              {
                "name": "existing",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select Workspace",
                "resourceType": "Microsoft.OperationalInsights/workspaces",
                "options": {
                  "filter": {
                    "subscription": "onBasics",
                    "location": "onBasics"
                  }
                },
                "visible": "[equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'existing')]"
              },
              {
                "name": "retentionInDays",
                "type": "Microsoft.Common.Slider",
                "min": 30,
                "max": 730,
                "label": "Log Retention",
                "subLabel": "days",
                "defaultValue": 90,
                "toolTip": "Number of days to retain log data",
                "constraints": {
                  "required": true
                },
                "visible": "[equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'new')]"
              }
            ]
          },
          {
            "name": "managedIdentitySection",
            "type": "Microsoft.Common.Section",
            "label": "Managed Identity",
            "elements": [
              {
                "name": "newOrExisting",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Managed Identity",
                "defaultValue": "new",
                "toolTip": "Create a new managed identity or use an existing one for deployment scripts",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Create new",
                      "value": "new"
                    },
                    {
                      "label": "Use existing",
                      "value": "existing"
                    }
                  ],
                  "required": true
                }
              },
              {
                "name": "name",
                "type": "Microsoft.Common.TextBox",
                "label": "Managed Identity Name",
                "defaultValue": "[concat('id-', basics('deploymentName'))]",
                "toolTip": "Name for the User-Assigned Managed Identity",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9-]{3,128}$",
                  "validationMessage": "Alphanumeric and hyphens. Length 3-128."
                },
                "visible": "[equals(steps('infrastructure').managedIdentitySection.newOrExisting, 'new')]"
              },
              {
                "name": "existing",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select Managed Identity",
                "resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
                "options": {
                  "filter": {
                    "subscription": "onBasics"
                  }
                },
                "visible": "[equals(steps('infrastructure').managedIdentitySection.newOrExisting, 'existing')]"
              },
              {
                "name": "identityInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "A User-Assigned Managed Identity is required to run deployment scripts that associate VMs with Data Collection Rules. You must manually grant this identity 'Contributor' role at the subscription level after deployment."
                }
              }
            ]
          },
          {
            "name": "vmMonitoringSection",
            "type": "Microsoft.Common.Section",
            "label": "Virtual Machine Monitoring",
            "elements": [
              {
                "name": "monitorVMs",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Monitor Virtual Machines",
                "defaultValue": "none",
                "toolTip": "Choose whether to monitor existing VMs now",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Don't monitor VMs now (configure later)",
                      "value": "none"
                    },
                    {
                      "label": "Select specific VMs to monitor",
                      "value": "selected"
                    },
                    {
                      "label": "Monitor all VMs in subscription",
                      "value": "all"
                    }
                  ],
                  "required": true
                }
              },
              {
                "name": "selectedVMResourceIds",
                "type": "Microsoft.Common.TextBox",
                "label": "VM Resource IDs",
                "placeholder": "/subscriptions/xxx/resourceGroups/rg/providers/Microsoft.Compute/virtualMachines/vm1,/subscriptions/xxx/resourceGroups/rg/providers/Microsoft.Compute/virtualMachines/vm2",
                "toolTip": "Enter full Resource IDs of VMs to monitor, separated by commas. Copy Resource ID from VM's Properties page.",
                "multiLine": true,
                "constraints": {
                  "required": true
                },
                "visible": "[equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'selected')]"
              },
              {
                "name": "vmInfoBoxSelected",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'selected')]",
                "options": {
                  "icon": "Info",
                  "text": "To get VM Resource ID: Go to VM → Properties → Copy 'Resource ID'. Paste multiple IDs separated by commas."
                }
              },
              {
                "name": "vmInfoBoxAll",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'all')]",
                "options": {
                  "icon": "Warning",
                  "text": "ALL Virtual Machines in the subscription will be discovered and monitored automatically. The deployment script will query all VMs and associate them with Data Collection Rules. This may take several minutes."
                }
              },
              {
                "name": "dcrNameWindows",
                "type": "Microsoft.Common.TextBox",
                "label": "Data Collection Rule Name (Windows)",
                "defaultValue": "[concat('dcr-', basics('deploymentName'), '-windows')]",
                "toolTip": "Name for the Windows Data Collection Rule",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9-]{3,64}$",
                  "validationMessage": "Alphanumeric and hyphens. Length 3-64."
                },
                "visible": "[not(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'none'))]"
              },
              {
                "name": "dcrNameLinux",
                "type": "Microsoft.Common.TextBox",
                "label": "Data Collection Rule Name (Linux)",
                "defaultValue": "[concat('dcr-', basics('deploymentName'), '-linux')]",
                "toolTip": "Name for the Linux Data Collection Rule",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9-]{3,64}$",
                  "validationMessage": "Alphanumeric and hyphens. Length 3-64."
                },
                "visible": "[not(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'none'))]"
              },
              {
                "name": "autoEnrollInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[not(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'none'))]",
                "options": {
                  "icon": "Info",
                  "text": "Data Collection Rules will be created and automatically associated with VMs using a deployment script. Azure Monitor Agent (AMA) must be installed separately via Azure Policy or manually."
                }
              }
            ]
          }
        ]
      },
      {
        "name": "monitoring",
        "label": "Monitoring",
        "elements": [
          {
            "name": "alertThresholdsSection",
            "type": "Microsoft.Common.Section",
            "label": "Alert Thresholds",
            "elements": [
              {
                "name": "cpuThreshold",
                "type": "Microsoft.Common.Slider",
                "min": 50,
                "max": 100,
                "label": "CPU Threshold",
                "subLabel": "%",
                "defaultValue": 85,
                "toolTip": "Alert when CPU usage exceeds this percentage",
                "constraints": {
                  "required": true
                }
              },
              {
                "name": "memoryThreshold",
                "type": "Microsoft.Common.Slider",
                "min": 50,
                "max": 100,
                "label": "Memory Threshold",
                "subLabel": "%",
                "defaultValue": 85,
                "toolTip": "Alert when Memory usage exceeds this percentage",
                "constraints": {
                  "required": true
                }
              },
              {
                "name": "diskThreshold",
                "type": "Microsoft.Common.Slider",
                "min": 50,
                "max": 100,
                "label": "Disk Threshold",
                "subLabel": "%",
                "defaultValue": 85,
                "toolTip": "Alert when Disk usage exceeds this percentage",
                "constraints": {
                  "required": true
                }
              }
            ]
          },
          {
            "name": "enabledAlertsSection",
            "type": "Microsoft.Common.Section",
            "label": "Enabled Alerts",
            "elements": [
              {
                "name": "enableCPUAlerts",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable CPU alerts",
                "defaultValue": true
              },
              {
                "name": "enableMemoryAlerts",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable Memory alerts",
                "defaultValue": true
              },
              {
                "name": "enableDiskAlerts",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable Disk alerts",
                "defaultValue": true
              },
              {
                "name": "enableHeartbeatAlerts",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable VM Heartbeat alerts",
                "toolTip": "Alert when VM stops sending heartbeat (VM offline)",
                "defaultValue": true
              }
            ]
          }
        ]
      },
      {
        "name": "notifications",
        "label": "Notifications",
        "elements": [
          {
            "name": "actionGroupName",
            "type": "Microsoft.Common.TextBox",
            "label": "Action Group Name",
            "defaultValue": "[concat('ag-', basics('deploymentName'))]",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "emailRecipients",
            "type": "Microsoft.Common.TextBox",
            "label": "Email Recipients",
            "placeholder": "admin@company.com;ops@company.com",
            "toolTip": "Semicolon-separated email addresses for alert notifications",
            "constraints": {
              "required": true,
              "regex": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}(;[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})*$",
              "validationMessage": "Enter valid email addresses separated by semicolons"
            }
          }
        ]
      },
      {
        "name": "automation",
        "label": "Automation",
        "elements": [
          {
            "name": "policySection",
            "type": "Microsoft.Common.Section",
            "label": "Azure Policy",
            "elements": [
              {
                "name": "enableAzurePolicy",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable Azure Policy for automatic VM enrollment",
                "defaultValue": false,
                "toolTip": "When enabled, Azure Policy will automatically install Azure Monitor Agent on new VMs and associate them with Data Collection Rules"
              },
              {
                "name": "policyInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[steps('automation').policySection.enableAzurePolicy]",
                "options": {
                  "icon": "Info",
                  "text": "Azure Policy will be deployed to automatically install Azure Monitor Agent (AMA) on new Virtual Machines and associate them with the appropriate Data Collection Rules. Policy remediation may take 15-30 minutes to complete."
                }
              },
              {
                "name": "policyDisabledInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[not(steps('automation').policySection.enableAzurePolicy)]",
                "options": {
                  "icon": "Warning",
                  "text": "Azure Policy is disabled. New VMs will NOT be automatically enrolled. You will need to manually install Azure Monitor Agent and associate Data Collection Rules."
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "deploymentName": "[basics('deploymentName')]",
      "useExistingLogAnalytics": "[equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'existing')]",
      "existingLogAnalyticsWorkspaceId": "[if(equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'existing'), steps('infrastructure').logAnalyticsSection.existing.id, '')]",
      "logAnalyticsWorkspaceName": "[if(equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'new'), steps('infrastructure').logAnalyticsSection.name, if(equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'existing'), steps('infrastructure').logAnalyticsSection.existing.name, concat('law-', basics('deploymentName'))))]",
      "retentionInDays": "[if(equals(steps('infrastructure').logAnalyticsSection.newOrExisting, 'new'), steps('infrastructure').logAnalyticsSection.retentionInDays, 90)]",
      "useExistingManagedIdentity": "[equals(steps('infrastructure').managedIdentitySection.newOrExisting, 'existing')]",
      "existingManagedIdentityId": "[if(equals(steps('infrastructure').managedIdentitySection.newOrExisting, 'existing'), steps('infrastructure').managedIdentitySection.existing.id, '')]",
      "managedIdentityName": "[if(equals(steps('infrastructure').managedIdentitySection.newOrExisting, 'new'), steps('infrastructure').managedIdentitySection.name, if(equals(steps('infrastructure').managedIdentitySection.newOrExisting, 'existing'), steps('infrastructure').managedIdentitySection.existing.name, concat('id-', basics('deploymentName'))))]",
      "monitorExistingVMs": "[or(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'selected'), equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'all'))]",
      "monitorAllVMs": "[equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'all')]",
      "selectedVMIds": "[if(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'selected'), split(replace(steps('infrastructure').vmMonitoringSection.selectedVMResourceIds, ' ', ''), ','), parse('[]'))]",
      "dcrNameWindows": "[if(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'none'), concat('dcr-', basics('deploymentName'), '-windows'), steps('infrastructure').vmMonitoringSection.dcrNameWindows)]",
      "dcrNameLinux": "[if(equals(steps('infrastructure').vmMonitoringSection.monitorVMs, 'none'), concat('dcr-', basics('deploymentName'), '-linux'), steps('infrastructure').vmMonitoringSection.dcrNameLinux)]",
      "enableAzurePolicy": "[steps('automation').policySection.enableAzurePolicy]",
      "autoEnrollNewVMs": "[steps('automation').policySection.enableAzurePolicy]",
      "enableCPUAlerts": "[steps('monitoring').enabledAlertsSection.enableCPUAlerts]",
      "cpuThreshold": "[steps('monitoring').alertThresholdsSection.cpuThreshold]",
      "enableMemoryAlerts": "[steps('monitoring').enabledAlertsSection.enableMemoryAlerts]",
      "memoryThreshold": "[steps('monitoring').alertThresholdsSection.memoryThreshold]",
      "enableDiskAlerts": "[steps('monitoring').enabledAlertsSection.enableDiskAlerts]",
      "diskThreshold": "[steps('monitoring').alertThresholdsSection.diskThreshold]",
      "enableHeartbeatAlerts": "[steps('monitoring').enabledAlertsSection.enableHeartbeatAlerts]",
      "createActionGroup": true,
      "actionGroupName": "[steps('notifications').actionGroupName]",
      "emailRecipients": "[steps('notifications').emailRecipients]",
      "deployDashboard": true,
      "dashboardName": "VM Monitoring Dashboard",
      "tagsByResource": {}
    }
  }
}